<!DOCTYPE html>
<html lang="en">

<head>
  <title>Who Is the Best Pokemon</title>
  <link rel="stylesheet" type="text/css" href="/style.css">

  <script>
    //communcate with external poke-api
    //some code here is based on my 235 project "Amiibo Shelf" https://people.rit.edu/lcs3087/235/project2/index.html
    //some code here is based on my 430 assignment HTTP API Assignment 2 https://luke-sullivan-http-api-2-9aad542a9f75.herokuapp.com/
    function getData() {
      // 1 - main entry point to web service
      const SERVICE_URL = "https://pokeapi.co/api/v2/pokemon?limit=100000&offset=0";

      // No API Key required!

      // 2 - build up our URL string
      // not necessary for this service endpoint
      let url = SERVICE_URL;

      // 3 - parse the user entered term we wish to search
      // not necessary for this service endpoint
      // let term = document.querySelector("#searchterm").value.trim();
      // term = encodeURIComponent(term);
      // let type = document.querySelector("#searchType").value;
      // url += type;
      // url += "=";
      // url += term;

      // 4 - update the UI
      document.querySelector("#content").innerHTML = `<b>Querying web service with:</b> <a href="${url}" target="_blank">${url}</a>`;

      // 5 - create a new XHR object
      let xhr = new XMLHttpRequest();


      // 6 - set the onload handler
      xhr.onload = dataLoaded;

      // 7 - set the onerror handler
      xhr.onerror = dataError;

      // 8 - open connection and send the request
      xhr.open("GET", url);
      xhr.send();
    }

    function dataError(e) {
      console.log("An error occurred");
    }

    function dataLoaded(e) {
      // 1 - e.target is the xhr object
      let xhr = e.target;

      // 2 - xhr.responseText is the JSON file we just downloaded
      console.log(xhr.responseText);

      // 3 - turn the text into a parsable JavaScript object
      let obj = JSON.parse(xhr.responseText);
      console.log(obj.results);

      //if there are no results, print a message and return
      if (!obj.results || obj.results.length == 0) {
        document.querySelector("#content").innerHTML = "<b>No results found</b>";
        //document.querySelector("#content").innerHTML = "";
        return; //Bail out
      }

      // 4 - if there is an array of results, loop through them
      results = obj.results;
      //let bigString = "";
      document.querySelector("#content").innerHTML = "<p><i>Here are the results!</i></p>";
      //randomly choose two pokemon
      let rightChoice = Math.floor(Math.random() * results.length);
      let leftChoice = Math.floor(Math.random() * results.length);

      console.log(results[121]);
      document.querySelector('#rightChoice').value = results[rightChoice].name;
      document.querySelector('#leftChoice').value = results[leftChoice].name;

      // 5 - display final results to user
      //document.querySelector("#content").innerHTML = bigString;
    }

    //Handles our FETCH response.
    const handleResponse = async (response, parseResponse) => {

      //Grab the content section
      const content = document.querySelector('#content');

      //Based on the status code, display something
      switch (response.status) {
        case 200: //success
          content.innerHTML = `<b>Success</b>`;
          break;
        case 201: //created
          content.innerHTML = '<b>Created</b>';
          break;
        case 204: //updated (no response back from server)
          content.innerHTML = '<b>Updated (No Content)</b>';
          return;
        case 400: //bad request
          content.innerHTML = `<b>Bad Request</b>`;
          break;
        case 404: //not real
          content.innerHTML = `<b>Not Found</b>`;
          break;
        default: //any other status code
          content.innerHTML = `Error code not implemented by client.`;
          break;
      }

      //If we should parse a response (meaning we made a get request)
      if (parseResponse) {
        //Parse the response to json. This is an async function, so we will await it.
        let obj = await response.json();

        //sort the returned data into an array
        let objArray = Object.values(obj.votes);
        objArray.sort((a,b) => {return b.points-a.points});

        //if the response is successful, display users
        if (response.status == 200) {
          //To display the data, we will loop through the votes and display them.
          objArray.forEach(pokemon => {
            content.innerHTML += `<p>${pokemon.name}: ${pokemon.points} votes</p>`;
          });
        }
        //otherwise, display the error message
        else {
          //Again, to display the data easily, we will just stringify it again and display it.
          let jsonString = JSON.stringify(obj.message);
          content.innerHTML += `<p>Message: ${jsonString}</p>`;
        }


      }
    };

    //Uses fetch to send a postRequest. Marksed as async because we use await
    //within it.
    const sendPost = async (voteForm, choiceMade) => {
      //Grab all the info from the form
      const voteAction = voteForm.getAttribute('action');
      const voteMethod = voteForm.getAttribute('method');

      const nameField = choiceMade;

      //Build a data string in the FORM-URLENCODED format.
      const formData = `name=${nameField}`;

      //Make a fetch request and await a response. Set the method to
      //the one provided by the form (POST). Set the headers. Content-Type
      //is the type of data we are sending. Accept is the data we would like
      //in response. Then add our FORM-URLENCODED string as the body of the request.
      let response = await fetch(voteAction, {
        method: voteMethod,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
        },
        body: formData,
      });

      //Once we have a response, handle it. The second parameter is a boolean
      //that says we should not parse the response.
      handleResponse(response, false);
    };

    //function to send request. This is marked as async since we will use await.
    const requestUpdate = async (getVotesForm) => {

      //Grab the url and method from the html form below
      const url = getVotesForm.querySelector('#urlField').value;
      const method = getVotesForm.querySelector('#methodSelect').value;

      //Await our fetch response. Go to the URL, use the right method, and attach the headers.
      let response = await fetch(url, {
        method,
        headers: {
          'Accept': 'application/json'
        },
      });

      //Once we have our response, send it into handle response. The second parameter is a boolean
      //that says if we should parse the response or not. We will get a response to parse on get
      //requests so we can do an inline boolean check, which will return a true or false to pass in.
      handleResponse(response, method === 'get');
    };

    const randomizeChoices = () => {
      //randomly generate two numbers to be the two choices to vote for
      getData();
    }

    //Init function is called when window.onload runs (set below).
    const init = () => {
      randomizeChoices();

      //grab user form
      const getVotesForm = document.querySelector('#getVotesForm');

      //function to handle our request. In this case, it also cancels the built in html form action
      const getVotes = (e) => {
        e.preventDefault();
        requestUpdate(getVotesForm);
        return false;
      }

      //add event listener
      getVotesForm.addEventListener('submit', getVotes);

      //Grab the vote form
      const voteForm = document.querySelector('#voteForm');

      //Create an addVote function that cancels the forms default action and
      //calls our sendPost function above.
      const addVote = (e) => {
        e.preventDefault();
        sendPost(voteForm, e.submitter.value);
        //re-randomize the choices after every vote
        randomizeChoices();
        return false;
      }

      //Call addVote when the submit event fires on the form.
      voteForm.addEventListener('submit', addVote);

    };

    //When the window loads, run init.
    window.onload = init;
  </script>
</head>

<body>
  <section id="top">
    <h3>POST Status Code Tests</h3>
    <form id="voteForm" action="/addVote" method="post">
      <input id="rightChoice" type="submit" value="Right Choice" />
      <input id="leftChoice" type="submit" value="Left Choice" />
    </form>
    <form id="getVotesForm" action="/getVotes" method="get">
      <select id='urlField'>
        <option value='/getVotes'>/getVotes</option>
      </select>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <input type="submit" value="Get Votes" />
    </form>
  </section>
  <section id="content">
  </section>
</body>

</html>
